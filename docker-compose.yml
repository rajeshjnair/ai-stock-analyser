version: '3.8'

services:
  nginx:
    image: nginx:alpine
    container_name: ai-stock-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - frontend
      - backend
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      frontend-website:
        condition: service_healthy
      backend-app:
        condition: service_started
      backend-api:
        condition: service_healthy
      ws-gateway:
        condition: service_healthy
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: ai-stock-redis
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  mongodb:
    image: mongo:7
    container_name: ai-stock-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: ai_stock_analyzer
    volumes:
      - mongo_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  frontend-website:
    build:
      context: ./apps/frontend-website
      dockerfile: Dockerfile
    container_name: ai-stock-frontend-website
    environment:
      - NODE_ENV=${NODE_ENV}
      - NEXT_PUBLIC_API_URL=http://backend-api:3001
      - NEXT_PUBLIC_WS_URL=ws://ws-gateway:8080
      - NEXT_PUBLIC_FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET}
      - NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_FIREBASE_APP_ID=${FIREBASE_APP_ID}
    networks:
      - frontend
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  backend-app:
    build:
      context: ./apps/backend-app
      dockerfile: Dockerfile
    container_name: ai-stock-backend-app
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/${MONGO_DATABASE}?authSource=admin
      - REDIS_URL=${REDIS_URL}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN}
      - FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET}
      - FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID}
      - FIREBASE_APP_ID=${FIREBASE_APP_ID}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY=${JWT_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY}
    networks:
      - backend
      - frontend
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    restart: unless-stopped

  backend-api:
    build:
      context: ./apps/backend-api
      dockerfile: Dockerfile
    container_name: ai-stock-backend-api
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${API_PORT}
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/${MONGO_DATABASE}?authSource=admin
      - REDIS_URL=${REDIS_URL}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN}
      - FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET}
      - FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID}
      - FIREBASE_APP_ID=${FIREBASE_APP_ID}
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRY=${JWT_EXPIRY}
      - REFRESH_TOKEN_EXPIRY=${REFRESH_TOKEN_EXPIRY}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - AI_ANALYSIS_TIMEOUT=${AI_ANALYSIS_TIMEOUT}
      - AI_MAX_RETRY_ATTEMPTS=${AI_MAX_RETRY_ATTEMPTS}
      - AI_CACHE_TTL=${AI_CACHE_TTL}
    networks:
      - backend
      - frontend
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }).on('error', () => process.exit(1));"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  ws-gateway:
    build:
      context: ./apps/backend-api
      dockerfile: Dockerfile.ws
    container_name: ai-stock-ws-gateway
    environment:
      - NODE_ENV=${NODE_ENV}
      - WS_PORT=${WS_PORT}
      - REDIS_URL=${REDIS_URL}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY}
      - FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN}
      - CORS_ORIGIN=${CORS_ORIGIN}
    networks:
      - backend
      - frontend
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('net').connect(8080, 'localhost').on('connect', () => process.exit(0)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  finnhub-manager:
    build:
      context: ./apps/backend-api
      dockerfile: Dockerfile.finnhub
    deploy:
      replicas: 1
    environment:
      - NODE_ENV=${NODE_ENV}
      - REDIS_URL=${REDIS_URL}
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
      - STOCK_UPDATE_INTERVAL=${STOCK_UPDATE_INTERVAL}
    networks:
      - backend
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const redis = require('ioredis'); const client = new redis(process.env.REDIS_URL); client.get('finnhub:manager:heartbeat').then(data => { if (!data) process.exit(1); const heartbeat = JSON.parse(data); const age = Date.now() - heartbeat.timestamp; process.exit(age > 60000 ? 1 : 0); }).catch(() => process.exit(1)).finally(() => client.disconnect());"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  analysis-worker:
    build:
      context: ./apps/backend-api
      dockerfile: Dockerfile.worker
    container_name: ai-stock-analysis-worker
    environment:
      - NODE_ENV=${NODE_ENV}
      - MONGODB_URI=mongodb://${MONGO_USER}:${MONGO_PASSWORD}@mongodb:27017/${MONGO_DATABASE}?authSource=admin
      - REDIS_URL=${REDIS_URL}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - AI_ANALYSIS_TIMEOUT=${AI_ANALYSIS_TIMEOUT}
      - AI_MAX_RETRY_ATTEMPTS=${AI_MAX_RETRY_ATTEMPTS}
      - AI_CACHE_TTL=${AI_CACHE_TTL}
    networks:
      - backend
    depends_on:
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "const redis = require('ioredis'); const client = new redis(process.env.REDIS_URL); client.ping().then(() => process.exit(0)).catch(() => process.exit(1)).finally(() => client.disconnect());"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    restart: unless-stopped

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge

volumes:
  redis_data:
    driver: local
  mongo_data:
    driver: local
